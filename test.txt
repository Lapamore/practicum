import json
import logging
from typing import Dict
from ..base import ITreeStep, TreeRequestContext
from ...repositories.core import IRoutingRepository
from mbi.copilot.src.components.llm.core import ILLM

__all__ = ["SelectProductGroupMis"]

logger = logging.getLogger(__name__)

class SelectProductGroupMis(ITreeStep):

    _CATEGORY_TO_KEY: Dict[str, str] = {
        # --- MIS ---
        "Агрегированные кубы, в т.ч. Управленческий куб": "select_aggregated_cubes_mis",
        "Кубы B2B": "select_b2b_mis",
        "Кубы B2C": "select_b2c_mis",
        "Навигатор": "select_navigator_mis",
        "Отчеты на Qlik Sense": "select_qlik_sense_mis",
        "Другие продукты, представленные на DR-Портале": "select_other_products_mis",
        
        # --- DR SREDA ---
        "Агрегированные кубы DR СРЕДА": "select_aggregated_cubes_dr_sreda",
        "Кубы КИБ DR СРЕДА": "select_cib_cubes_dr_sreda",
        "Кубы РБ DR СРЕДА": "select_rb_cubes_dr_sreda",
        "Кубы ОФР DR СРЕДА": "select_ofr_cubes_dr_sreda"
    }

    def __init__(self, llm: ILLM, routing_repo: IRoutingRepository) -> None:
        self._llm = llm
        self._routing_repo = routing_repo

    @property
    def name(self) -> str:
        return "select_product_group_mis"

    async def execute(self, context: TreeRequestContext) -> TreeRequestContext:
        history = context.history
        
        history_text = "\n".join([f"{msg.type}: {msg.content}" for msg in history[1:]])

        prompt_lines = [
            "Ты — диспетчер технической поддержки банка.",
            "Твоя задача — на основе истории диалога классифицировать запрос пользователя, выбрав правильную ГРУППУ и КАТЕГОРИЮ.",
            "Ты должен понимать, какой конкретный продукт ищет пользователь, и сопоставить его с описанием содержимого категорий ниже.",
            "",
            "### СТРУКТУРА ПРОДУКТОВ (ГДЕ ЧТО ЛЕЖИТ):",
            "",
            "=== ГРУППА 1: 'Olap-кубы MIS, Навигатор, Отчеты на Qlik Sence' ===",
            "(Включает старые/основные кубы MIS, отчетность Qlik, Навигатор)",
            "",
            "   1. КАТЕГОРИЯ: 'Кубы B2B' (Юридические лица MIS)",
            "      - Содержит: Кредиты ЮЛ (M0009, M0010), Пассивы ЮЛ (P0024), Комиссии/Штрафы/РВП (P0019), ФОТ (M0036), RoRWA, Конверсионные операции, Облигации, ПФИ, Брокерские операции, Гарантии ЮЛ (M0084, M0097), ДЗО, ВЭД, Аккредитивы ЮЛ.",
            "",
            "   2. КАТЕГОРИЯ: 'Кубы B2C' (Розничный бизнес MIS)",
            "      - Содержит: Кредиты ФЛ (P0051), Вклады/Пассивы ФЛ (P0012, P0052), Банковские карты (P0037, P0022), Эквайринг, Сберегательные сертификаты, Продукты благосостояния, PL ВСП, Переводы, Денежная наличность, Монеты/Слитки, Сейфы, Эскроу ФЛ, БСП, Устройства самообслуживания.",
            "",
            "   3. КАТЕГОРИЯ: 'Агрегированные кубы, в т.ч. Управленческий куб'",
            "      - Содержит: Управленческий куб (Факт ПАО), Новый оперативный куб (НОК), Оперативный бухгалтерский куб (ОБК), Новый бухгалтерский куб (НБК), Куб по Недвижимости.",
            "",
            "   4. КАТЕГОРИЯ: 'Навигатор'",
            "      - Содержит: Все дэшборды Навигатора (Оперативный отчет, СберПрайм, Доли рынка, Финансы ТБ/ГОСБ/КИБ, Царь-дэшборд, PL ВСП, Отраслевая аналитика, RoRWA).",
            "",
            "   5. КАТЕГОРИЯ: 'Отчеты на Qlik Sense'",
            "      - Содержит: BI Активы ФЛ, ОВБП, Куб эквайринг (Qlik).",
            "",
            "   6. КАТЕГОРИЯ: 'Другие продукты, представленные на DR-Портале'",
            "      - Содержит: Группа Сбербанк БМО, Доля Сбербанка (887-4-р), Банковская система.",
            "",
            "   7. КАТЕГОРИЯ: 'Доступ к DR-Порталу и продуктам MIS'",
            "      - Выбирать, если вопрос про права доступа к вышеперечисленному. (СТОП-ФАКТОР -> group_code='m0100')",
            "",
            "=== ГРУППА 2: 'Продукты DR СРЕДА' ===",
            "(Новая среда, часто дублирует названия, но имеет приставку DR СРЕДА или коды на 's')",
            "",
            "   1. КАТЕГОРИЯ: 'Кубы КИБ DR СРЕДА'",
            "      - Содержит: Куб по Гарантиям (s0004), Некредитные комиссии/Штрафы/РВП (s0005), Пассивы ЮЛ (s0011), ДЗО (s0012), Корпоративные клиенты (s0021), Аккредитивы ЮЛ (s0013), Платежная аналитика, ВЭД (s0015), Совокупный кредитный доход, ДРПА ЮЛ, Кредиты ЮЛ (s0018, s0019), СЦП.",
            "",
            "   2. КАТЕГОРИЯ: 'Кубы РБ DR СРЕДА'",
            "      - Содержит: БСП (s0007), Платежи/Переводы (s0008, s0009), Монеты (s0010), ФОТ (s0006), Банковские карты (s0023), Устройства самообслуживания (s0024), Эквайринг (s0025), Продукты благосостояния, Вклады/Пассивы ФЛ (s0027, s0028), Эскроу ФЛ, Кредиты ФЛ (s0031), ДРПА ФЛ, PL ВСП (s0033), Сейфы, Бюджетные зачисления, Денежная наличность (s0044).",
            "",
            "   3. КАТЕГОРИЯ: 'Кубы ОФР DR СРЕДА'",
            "      - Содержит: Облигации (s0022), Акционерный риск, Конверсионные операции (s0034), ПФИ (s0035), Брокерские операции (s0036), Куб по ОФР (s0040).",
            "",
            "   4. КАТЕГОРИЯ: 'Агрегированные кубы DR СРЕДА'",
            "      - Содержит: Управленческий куб (s0001), Доходные договоры (s0002), Недвижимость (s0003), Бухгалтерский куб (s0041, s0042), Новый оперативный куб (s0043).",
            "",
            "   5. КАТЕГОРИЯ: 'Доступ к Кубам DR СРЕДА'",
            "      - Выбирать, если вопрос про права доступа именно к DR СРЕДА. (СТОП-ФАКТОР -> group_code='m0100')",
            "",
            "### ИНСТРУКЦИЯ ПО ВЫБОРУ:",
            "1. Внимательно ищи упоминание 'DR СРЕДА' или специфичных кодов (s00xx) в запросе. Если они есть — это ГРУППА 2.",
            "2. Если явного указания на DR СРЕДА нет, но есть коды M00xx/P00xx или просто название продукта (Кредиты ЮЛ) — это чаще ГРУППА 1 (MIS).",
            "3. Найди продукт в списках 'Содержит' выше.",
            "",
            "### ЛОГИКА ВОЗВРАТА group_code:",
            "1. Если выбрана категория 'Доступ к DR-Порталу и продуктам MIS' -> group_code = 'm0100'",
            "2. Если выбрана категория 'Доступ к Кубам DR СРЕДА' -> group_code = 'm0100'",
            "3. Во всех остальных случаях -> group_code = null",
            "",
            "### ИСТОРИЯ ДИАЛОГА:",
            f"{history_text}",
            "",
            "### ФОРМАТ ОТВЕТА (СТРОГО JSON):",
            "{",
            '  "reasoning": "краткое объяснение, почему этот продукт отнесен именно к этой категории (например: пользователь упомянул s0004, это код из DR СРЕДА)",',
            '  "product_group": "Точное название группы из списка выше",',
            '  "product_category": "Точное название категории из списка выше",',
            '  "group_code": "m0100 или null"',
            "}"
        ]

        response_raw = await self._llm.ainvoke(request="\n".join(prompt_lines))
        
        try:
            clean_json = response_raw.replace("```json", "").replace("```", "").strip()
            # logger.info(f"SelectProductGroupMis raw response: {clean_json}") # Полезно для отладки
            data = json.loads(clean_json)
        except json.JSONDecodeError:
            logger.error(f"Failed to decode JSON from LLM: {response_raw}")
            data = {}

        group_code = data.get("group_code")
        category = data.get("product_category")
        context.product_group = data.get("product_group")
        context.product_category = category

        # Если это категория доступа (стоп-фактор) или LLM сразу вернула код группы
        if group_code and group_code.lower() != "null":
            group_ids = await self._routing_repo.get_working_group_ids(group_code=group_code)
            context.group_ids = group_ids
            context.group_code = group_code
            context.should_stop = True
            return context
        
        # Если определена категория, переходим к следующему шагу (выбор конкретного продукта внутри категории)
        if category:
            context.prompt_key = self._CATEGORY_TO_KEY.get(category.strip())
            if not context.prompt_key:
                logger.warning(f"No prompt key found for category: {category}")

        return context